---
title: Using Crunchy PostgreSQL for PCF
owner: Crunchy Data 
---

This topic describes how to use Crunchy PostgreSQL for Pivotal Cloud Foundry (PCF).

##<a id='using'></a> Crunchy PostgreSQL Services and Plans

Crunchy PostgreSQL is an On-Demand, Single Tenant PostgreSQL database service.  
Crunchy PostgreSQL comes with one service:

* postgresql-9.5-odb

This service includes:
* PostgreSQL Cluster (Primary and Replicas)
* Load Balancer
* pgBackrest Dedicated Backup
* Consul Cluster

###<a id='using-pgsql-95'></a> PostgreSQL 9.5 Service

The `postgresql-9.5` service comes with two plans:

* small
* medium
* large
* extra-large

Each plan corresponds to different server size setup by the operator who deployed 
the service.  

Review each plans offering and choose the right database size for the application.

####<a id='using-pgsql-95'></a> Create PostgreSQL 9.5 Service

Creating a service requires four parameters used with the create-service request:

  * `db_name` is the database name being requested.
  * `db_username` is the username being requested.
  * `owner_name` is meta information about the owner of this database.
  * `owner_email` is the email address where the owner can be contacted.

Optional parameters:

  * `postgis` will install PostGIS 2.2 extensions.
  * `db_encoding` will change the default decoding of the database. This is not recommended. 
  * `hba_addresses` a space separated list of IP addresses and/or networks in CIDR format that will be authorized to connect to the service database as the service user.

Follow the steps below to create and bind a service instance of Crunchy PostgreSQL to use with your app.

**NOTE**: With an on-demand service, new servers are built and configured when a new 
service is created, therefore this step will take some time to complete. You can check the status of your service from the space dashboard, in the Services tab.

1. Create a service instance using the following command as a template:

    <pre class="terminal">
    cf create-service postgresql-9.5-odb small myService -c '
    {
        "db_name": "crunchydb",
        "db_username": "crunchy",
        "owner_name": "Crunchy Data",
        "owner_email": "admin@crunchydata.com"
    }'
    </pre>

1. Bind the service instance to your application:

    <pre class="terminal">
    cf bind-service APP_NAME SERVICE_INSTANCE_NAME
    </pre>

1. Run the following commands to restage your app so that it can use the service:

    <pre class="terminal">
    cf bind-service APP_NAME SERVICE_NAME
    cf restage APP_NAME
    </pre>

##<a id='disaster'></a> Backups

Crunchy PostgreSQL uses `pgBackrest` for physical backups of the database.  Backups are taken every night at 1 AM, 7 days a week. Monday through Saturday will take incremental backups, while Sunday will create a new full backup.  

All archives from the database server are stored on the dedicated backup host.  This means that databases can be restored to specific points in time.

Currently, individual databases cannot be restored. All databases will be restored in the shared cluster.

##<a id='disaster-recovery'></a> Restore Deltas

These instructions demonstrate how the database can be restored using only deltas between the backup and the database.

The following requires an administrator to SSH to the `postgresql-master` server. 
For guidance on SSHing to servers in the service, see the [Pivotal documentation](https://docs.pivotal.io/pivotalcf/1-8/customizing/trouble-advanced.html).

1. First, ssh into the `postgresql-master` server using the `bosh` tool:
    <pre class="terminal">
    bosh ssh postgresql-master
    </pre>

1. Switch to the root user: 
    <pre class="terminal">
    sudo -i 
    </pre>

1. Stop postgresql services:
    <pre class="terminal">
    monit stop postgresql
    </pre>

1. Switch to the `vcap` user:
    <pre class="terminal">
    su - vcap
    </pre>

1. Verify that backups are available:
    <pre class="terminal">
    pgbackrest --config=/var/vcap/store/pgbackrest/config/pgbackrest.conf \
      --stanza=main info
    </pre>

1. Restore the database:
    <pre class="terminal">
    pgbackrest --config=/var/vcap/store/pgbackrest/config/pgbackrest.conf \
      --stanza=main \
      --delta restore
    </pre>

1. Switch to root:
    <pre class="terminal">
    sudo -i
    </pre>

1. Start the database:
    <pre class="terminal">
    monit start postgresql
    </pre>

##<a id='disaster-recovery'></a> Restore Point In Time

These instructions will demonstrate how the database can be restored using a point in time.

The following requires an administrator to SSH to the `postgresql-master` server.
For guidance on SSHing to servers in the service, see the [Pivotal documentation](https://docs.pivotal.io/pivotalcf/1-8/customizing/trouble-advanced.html).

1. First, ssh into the `postgresql-master` server using the `bosh` tool:
    <pre class="terminal">
    bosh ssh postgresql-master
    </pre>

1. Switch to the root user:
    <pre class="terminal">
    sudo -i
    </pre>

1. Stop postgresql services:
    <pre class="terminal">
    monit stop postgresql
    </pre>

1. Switch to the `vcap` user:
    <pre class="terminal">
    su - vcap
    </pre>

1. Verify that backups are available:
    <pre class="terminal">
    pgbackrest --config=/var/vcap/store/pgbackrest/config/pgbackrest.conf --stanza=main info
    </pre>

1. Restore the database:
    <pre class="terminal">
    pgbackrest --config=/var/vcap/store/pgbackrest/config/pgbackrest.conf \
        --stanza=main \
        --delta \
        --type=time "--target=2016-12-13 00:11:34.531619+00" restore
    </pre>

1. Switch to root:
    <pre class="terminal">
    sudo -i
    </pre>

1. Start the database:
    <pre class="terminal">
    monit start postgresql
    </pre>

##<a id='disaster-recovery'></a> pgBackrest Additional Information

For more information regarding pgBackrest restorations, see the [official documentation](http://www.pgbackrest.org/user-guide.html).
